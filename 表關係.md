# 系統表關係與操作整理

## 資料表總覽

| 表名 | 主要欄位/用途 | 關聯/備註 |
| --- | --- | --- |
| clients | `id`, `name` | 單純選項表，供任務/會議關聯名稱使用。 | 
| vendors | `id`, `name` | 單純選項表，供任務/會議關聯名稱使用。 | 
| products | `id`, `name` | 單純選項表，供任務/會議關聯名稱使用。 | 
| task_tags | `id`, `name` | 單純選項表，供任務標籤使用。 | 
| users | `mail`, `password_hash`, `icon`, `username`, `role` | 系統使用者資料。 | 
| auth_tokens | `mail`, `token_hash`, `expires_at` | 登入後的 session token。`mail` 對應 `users.mail`。 |
| tasks | `client_name`, `vendor_name`, `product_name`, `tag_name` | 建表後未見使用（目前主要任務資料使用 `task_submissions`）。 |
| task_submissions | `client_name`, `vendor_name`, `product_name`, `created_by_email` | 任務主表（建立/更新/刪除）。 |
| task_submission_users | `submission_id`, `user_mail` | 任務 ↔ 使用者 (多對多)。`submission_id` 對應 `task_submissions.id`，`user_mail` 對應 `users.mail`。 |
| task_submission_tags | `submission_id`, `tag_name` | 任務 ↔ 標籤 (多對多)。`submission_id` 對應 `task_submissions.id`。 |
| follow_up_statuses | `id`, `name`, `bg_color` | 跟進狀態主檔。 |
| task_submission_followups | `submission_id`, `content`, `status_id` | 任務 ↔ 跟進內容 (一對多)。`submission_id` 對應 `task_submissions.id`，`status_id` 對應 `follow_up_statuses.id`。 |
| task_submission_followup_assignees | `followup_id`, `user_mail` | 跟進內容 ↔ 使用者 (多對多)。`followup_id` 對應 `task_submission_followups.id`，`user_mail` 對應 `users.mail`。 |
| meeting_folders | `client_name`, `vendor_name`, `product_name`, `meeting_time`, `created_by_email` | 會議資料夾主表。 |
| meeting_records | `folder_id`, `file_name`, `content_text` | 會議檔案記錄。`folder_id` 對應 `meeting_folders.id`。 |
| meeting_reports | `folder_id`, `content_text` | 會議整合報告。`folder_id` 對應 `meeting_folders.id`。 |
| client_vendor_links | `client_name`, `vendor_name` | 客戶 ↔ 廠商對應，用於會議資料的階層查詢。 |
| vendor_product_links | `vendor_name`, `product_name` | 廠商 ↔ 產品對應，用於會議資料的階層查詢。 |
| product_meeting_links | `product_name`, `meeting_folder_id` | 產品 ↔ 會議資料夾對應。`meeting_folder_id` 對應 `meeting_folders.id`。 |

> 上述表結構皆由 `server/index.js` 初始化建立。詳細欄位可參考建表 SQL。 

## 關聯與依賴關係

### 1. 任務主流程（task_submissions）

```
users (mail)
   ▲                    follow_up_statuses (id)
   │                         ▲
   │                         │
   │                task_submission_followups (status_id)
   │                         ▲
   │                         │
   │        task_submission_followup_assignees (followup_id, user_mail)
   │                         ▲
   │                         │
   │          task_submission_users (submission_id, user_mail)
   │                         ▲
   │                         │
   └──────── task_submissions (id, created_by_email)
            ▲        ▲        ▲
            │        │        │
            └─ task_submission_tags (submission_id)
```

- **主表**：`task_submissions`。
- **關聯使用者**：透過 `task_submission_users` 記錄任務與使用者的多對多關係。
- **關聯標籤**：透過 `task_submission_tags` 記錄任務與標籤關係。
- **跟進內容**：`task_submission_followups` 以 `submission_id` 連結任務，並可參考 `follow_up_statuses`。
- **跟進指派**：`task_submission_followup_assignees` 連結跟進內容與使用者，並限制只能指派到 `task_submission_users` 中的關聯用戶。

### 2. 會議記錄流程（meeting_folders）

```
meeting_folders (id)
   ▲
   │
meeting_records (folder_id)
   ▲
   │
meeting_reports (folder_id)

client_vendor_links (client_name, vendor_name)
   ▲
   │
vendor_product_links (vendor_name, product_name)
   ▲
   │
product_meeting_links (product_name, meeting_folder_id)
```

- **主表**：`meeting_folders`。
- **檔案記錄**：`meeting_records` 以 `folder_id` 關聯資料夾。
- **整合報告**：`meeting_reports` 以 `folder_id` 對應一份報告。
- **階層索引**：`client_vendor_links` / `vendor_product_links` / `product_meeting_links` 用於查詢「客戶 → 廠商 → 產品 → 會議」結構。

### 3. 使用者/驗證流程

- `users` 保存帳號資料。
- `auth_tokens` 以 `mail` 連結使用者，並存放 token 與到期時間。

### 4. 基礎選項表（可獨立維護）

- `clients`, `vendors`, `products`, `task_tags` 為單純名稱清單，僅透過 API CRUD 維護。

## 各表操作整理（依 API 行為）

### 1. 選項維護

| API | 影響表 | 操作 |
| --- | --- | --- |
| `GET /api/options/:type` | clients / vendors / products / task_tags | 讀取清單。 |
| `POST /api/options/:type` | clients / vendors / products / task_tags | 新增項目。 |
| `DELETE /api/options/:type` | clients / vendors / products / task_tags | 刪除項目。 |

### 2. 任務（task_submissions）

| API | 影響表 | 操作 |
| --- | --- | --- |
| `POST /api/task-submissions` | task_submissions + task_submission_users + task_submission_tags + task_submission_followups + task_submission_followup_assignees | 建立任務 + 關聯用戶 + 標籤 + 跟進 + 指派。 |
| `GET /api/task-submissions` | 同上 + users + follow_up_statuses | 讀取任務及其關聯（JOIN）。 |
| `PUT /api/task-submissions/:id` | task_submissions + task_submission_users + task_submission_tags + task_submission_followups | 更新任務，先清除舊關聯再重建。 |
| `DELETE /api/task-submissions/:id` | task_submissions + task_submission_users + task_submission_tags + task_submission_followups + task_submission_followup_assignees | 依序刪除跟進指派 → 跟進 → 標籤 → 關聯用戶 → 任務。 |
| `PUT /api/task-submission-followups/:id` | task_submission_followups + task_submission_followup_assignees | 更新跟進狀態與指派。 |

### 3. 跟進狀態（follow_up_statuses）

| API | 影響表 | 操作 |
| --- | --- | --- |
| `GET /api/follow-up-statuses` | follow_up_statuses | 讀取狀態清單。 |
| `POST /api/follow-up-statuses` | follow_up_statuses | 新增狀態（若名稱重複則回傳既有資料）。 |
| `PUT /api/follow-up-statuses/:id` | follow_up_statuses | 更新狀態名稱/顏色。 |
| `DELETE /api/follow-up-statuses/:id` | follow_up_statuses | 刪除狀態。 |

### 4. 會議記錄（meeting_*）

| API | 影響表 | 操作 |
| --- | --- | --- |
| `POST /api/meeting-records` | meeting_folders + meeting_records + client_vendor_links + vendor_product_links + product_meeting_links | 建立資料夾並寫入檔案與階層索引。 |
| `POST /api/meeting-records/:id` | meeting_records | 在既有資料夾新增檔案。 |
| `DELETE /api/meeting-records/:id` | meeting_records | 刪除單一檔案記錄。 |
| `DELETE /api/meeting-folders/:id` | meeting_folders + meeting_records + meeting_reports + product_meeting_links | 刪除資料夾與其關聯資料。 |
| `POST /api/meeting-reports/:id` | meeting_reports | 生成/更新會議整合報告。 |
| `GET /api/meeting-records` | meeting_folders + meeting_records + meeting_reports + client_vendor_links + vendor_product_links + product_meeting_links | 讀取並組合階層式會議資料。 |

### 5. 使用者/驗證

| API | 影響表 | 操作 |
| --- | --- | --- |
| `POST /api/auth/register` | users | 新增使用者。 |
| `POST /api/auth/login` | users + auth_tokens | 驗證密碼並建立 token。 |
| `POST /api/auth/verify` | users + auth_tokens | 驗證 token 並回傳使用者資料。 |
| `POST /api/users/update` | users | 更新使用者資料與密碼。 |
| `GET /api/users` | users | 讀取使用者清單。 |

## 備註

- 系統未顯式建立外鍵（僅以欄位/索引維護關聯），因此刪除需在程式中手動維持依賴順序。
- `tasks` 表目前未見實際 API 使用，主要任務流程集中於 `task_submissions` 系列表。
