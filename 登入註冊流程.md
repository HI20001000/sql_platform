# 用戶登入/註冊流程說明

## 1. 數據庫與資料表
- **資料庫名稱**：`aisql`（伺服器啟動時會自動建立）。
- **主要資料表**：
  - `users`：保存使用者資訊與密碼雜湊。
  - `auth_tokens`：保存登入後的 token 與過期時間。

伺服器啟動時會呼叫 `ensureDatabase` / `ensureTables`，確保 `aisql` 與資料表存在；若 `users` 表為空，會自動建立預設管理者帳號。

## 2. 密碼加密方式（註冊 / 登入）
- 使用 **PBKDF2** 進行密碼雜湊：
  - `crypto.pbkdf2(password, salt, 100000, 64, 'sha512')`
  - 每個使用者會產生獨立的 `password_salt`（16 bytes 隨機）。
  - 註冊時將雜湊結果寫入 `users.password_hash`。
- 登入時：
  1. 讀取 `users.password_salt`。
  2. 使用相同參數重新計算雜湊。
  3. 比對 `password_hash` 是否一致。

## 3. 註冊流程（/api/auth/request-code + /api/auth/register）
1. **請求驗證碼**：
   - `POST /api/auth/request-code`
   - 後端會將驗證碼暫存於記憶體 `verificationCodes` Map 中（有效 60 秒）。
2. **註冊**：
   - `POST /api/auth/register`
   - 驗證驗證碼後：
     - 產生 `salt` + `password_hash`。
     - 寫入 `users` 表。
   - 若 email 已存在，回傳 409。

## 4. 登入流程（/api/auth/login）
1. `POST /api/auth/login`
2. 從 `users` 表查詢使用者資料。
3. 依 `password_salt` 重新計算雜湊並比對。
4. 成功後：
   - 產生隨機 token（`crypto.randomBytes(32)`）。
   - 使用 SHA-256 對 token 雜湊後存入 `auth_tokens`。
   - 回傳 token、expiresAt 及 user 資訊。

## 5. Token 與資料庫操作重點
- **Token 儲存表**：`auth_tokens`
- **操作行為**：
  - 登入時會先刪除該用戶舊 token 與過期 token。
  - 再插入新的 token 與過期時間。

## 6. 相關程式位置
- `server/index.js`
  - `hashPassword`：PBKDF2 實作
  - `registerUser`：註冊流程
  - `loginUser`：登入流程
  - `createAuthToken`：token 建立與寫入資料庫
